在 Kubernetes（K8s）中，**网络模式**的核心目标是解决容器间、Pod 间、Pod 与外部网络的通信问题，其设计遵循 **“每个 Pod 一个独立 IP”** 的核心原则（即 Pod IP 模型），确保 Pod 内的容器可直接通信、Pod 间通信无需 NAT、节点与 Pod 可直接通信。以下将从 **核心网络模式** 和 **主流网络组件（CNI 插件）** 两方面详细介绍。


## 一、K8s 核心网络模式
K8s 本身不直接实现网络，而是通过 **CNI（Container Network Interface，容器网络接口）** 规范定义网络插件的接入标准，不同 CNI 插件对应不同的网络实现逻辑，但本质上均围绕以下核心通信场景设计，可理解为“网络模式”的具体体现：

### 1. 容器内通信（Pod 内容器间）
- **原理**：同一 Pod 内的所有容器共享一个 **Network Namespace（网络命名空间）**，相当于处于同一“网络隔离域”，共享 Pod 的 IP 地址、端口、网络设备（如 `eth0`）。
- **通信方式**：容器间可通过 `localhost` + 端口直接通信，无需跨网络转发。
- **示例**：一个 Pod 内包含“应用容器”和“Sidecar 容器（如日志收集、监控）”，Sidecar 可通过 `localhost:8080` 访问应用容器的服务。


### 2. Pod 间通信（同一节点/跨节点）
这是 K8s 网络的核心场景，需满足“Pod IP 全局唯一”和“跨节点直接通信”，主要通过以下两种底层技术实现（由 CNI 插件封装）：
#### （1）Overlay 网络模式
- **原理**：在现有物理网络之上构建一层虚拟网络（如 VXLAN、GRE 隧道），将 Pod 的 IP 数据包封装在物理网络的数据包中转发，实现跨节点 Pod 通信。
- **特点**：
  - 无需修改物理网络拓扑，部署灵活；
  - 因封装/解封装过程，存在轻微性能损耗；
  - 适合物理网络不支持 Underlay 模式的场景（如公有云、传统数据中心）。


#### （2）Underlay 网络模式
- **原理**：Pod 直接使用物理网络的 IP 地址（与节点在同一网段），Pod 数据包无需封装，直接在物理网络中转发（需物理交换机支持）。
- **特点**：
  - 性能接近物理机（无封装损耗）；
  - 需物理网络配合（如支持 ARP 代理、VLAN 划分），部署门槛较高；
  - 适合对网络延迟敏感的场景（如 AI 训练、高频交易）。


### 3. Pod 与外部网络通信
Pod 访问外部（如公网、企业内网）或外部访问 Pod，需以下组件配合，本质是“网络地址转换（NAT）”或“负载均衡”：
#### （1）Pod 访问外部网络
- **原理**：节点通过 **SNAT（源地址转换）** 将 Pod 的私有 IP 转换为节点的物理 IP，外部网络仅感知节点 IP，实现 Pod 对外通信。
- **示例**：Pod（IP：10.244.1.5）访问百度，节点将数据包源 IP 改为节点 IP（如 192.168.1.100），百度响应后，节点再通过 DNAT 将目标 IP 改回 Pod IP。

#### （2）外部访问 Pod
- **原理**：通过 K8s 的 **Service（服务）** 资源，结合 **NodePort、LoadBalancer、Ingress** 等方式暴露 Pod 服务：
  - **NodePort**：在每个节点上开放一个静态端口，外部通过“节点 IP:NodePort”访问 Pod；
  - **LoadBalancer**：借助云厂商的负载均衡器（如 AWS ELB、阿里云 SLB），将流量转发到 NodePort，适合公网访问；
  - **Ingress**：通过 Ingress Controller（如 Nginx、Traefik）统一管理 HTTP/HTTPS 路由，转发到后端 Service，适合多域名、多路径的场景。


### 4. 网络策略（Network Policy）
严格来说，Network Policy 不是“网络模式”，而是 **网络访问控制规则**，用于限制 Pod 间的通信（类似防火墙），是 K8s 网络安全的核心：
- **功能**：基于 Pod 标签（Label）、命名空间（Namespace）、端口、IP 段定义“允许/拒绝”规则；
- **示例**：仅允许“命名空间=prod”且“标签=app=backend”的 Pod 访问“标签=app=database”的 Pod 的 3306 端口；
- **依赖**：需 CNI 插件支持（如 Calico、Cilium），原生 `bridge` 插件不支持。


## 二、主流 K8s 网络组件（CNI 插件）
CNI 插件是 K8s 网络的“实现者”，不同插件支持的网络模式、功能、性能差异较大，以下是生产环境中最常用的 5 类组件：

| 组件名称       | 核心技术         | 支持网络模式 | 关键特点                                                                 | 适用场景                     |
|----------------|------------------|--------------|--------------------------------------------------------------------------|------------------------------|
| **Calico**     | BGP 路由 + BPF   | Overlay/Underlay | 1. 基于 BGP 协议实现跨节点路由（无隧道封装，性能接近 Underlay）；<br>2. 原生支持 Network Policy；<br>3. 支持大规模集群（万级节点） | 中大型集群、对性能和安全要求高的场景 |
| **Flannel**    | VXLAN/Geneve 隧道 | Overlay      | 1. 最经典、部署最简单的 CNI 插件；<br>2. 仅支持基础 Pod 通信，无 Network Policy；<br>3. 性能一般（VXLAN 封装损耗） | 小型测试集群、对功能要求简单的场景 |
| **Cilium**     | eBPF + XDP       | Overlay/Underlay | 1. 基于 eBPF 技术（内核层转发，性能远超传统插件）；<br>2. 支持细粒度 Network Policy（L7 层，如 HTTP 路径）；<br>3. 集成服务网格（Istio）、负载均衡 | 对性能、安全（L7 控制）敏感的场景 |
| **Weave Net**  | VXLAN 隧道       | Overlay      | 1. 支持“去中心化”部署（无中心节点，自愈能力强）；<br>2. 内置 DNS 服务，支持跨节点 Pod 名解析；<br>3. 支持 Network Policy | 中小规模集群、对可用性要求高的场景 |
| **Macvlan**    | 虚拟网卡（Mac 地址） | Underlay     | 1. 为每个 Pod 分配独立 Mac 地址，模拟物理网卡；<br>2. Pod IP 与节点在同一网段，无封装损耗；<br>3. 需物理交换机支持“允许多 Mac 地址” | 对延迟敏感的场景（如工业控制、AI） |


## 三、总结
1. **网络模式的本质**：K8s 网络围绕“Pod IP 全局唯一”设计，通过 Overlay/Underlay 实现 Pod 间通信，通过 SNAT/LoadBalancer/Ingress 实现与外部通信，通过 Network Policy 保障安全。
2. **组件选择原则**：
   - 测试/小型集群：优先 **Flannel**（简单）；
   - 中大型/生产集群：优先 **Calico**（性能+安全）或 **Cilium**（eBPF 高性能）；
   - 低延迟场景：优先 **Macvlan**（Underlay）；
   - 高可用场景：优先 **Weave Net**（去中心化）。
3. **核心依赖**：所有网络功能均基于 CNI 规范，需确保 Kubelet 配置中指定 CNI 插件目录（如 `/etc/cni/net.d`），插件启动后自动注入网络配置。