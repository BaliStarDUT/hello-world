在 Kubernetes（K8s）网络中，虚拟网络设备是实现 Pod 通信、网络隔离和跨节点连接的核心组件，由 CNI 插件（如 Calico、Flannel 等）负责创建和管理。以下是 K8s 中常用的虚拟网络设备及其作用：


### 1. veth 对（veth pair）
- **本质**：一对虚拟以太网接口（类似“虚拟网线”），两端分别处于不同的网络命名空间（Network Namespace），一端发送的数据包会直接被另一端接收。
- **作用**：连接 Pod 的网络命名空间与节点的根网络命名空间，是 Pod 与节点网络交互的“桥梁”。
- **工作原理**：
  - 当 Pod 启动时，CNI 插件会创建一对 veth 设备（如 `vethabc123` 和 `eth0`）。
  - 其中一端（`eth0`）被放入 Pod 的网络命名空间，作为 Pod 的“网卡”，并分配 Pod IP。
  - 另一端（`vethabc123`）留在节点的根网络命名空间，通常会连接到节点的虚拟网桥（如 `cni0`）。
- **示例**：Pod 内的容器通过 `eth0` 发送数据，数据通过 veth 对传输到节点的根网络命名空间，再由节点转发到其他 Pod 或外部网络。


### 2. 虚拟网桥（Bridge，如 cni0、docker0）
- **本质**：虚拟的二层网络设备（类似物理交换机），用于在同一节点内转发数据包，实现多个网络接口（如 veth 对的节点端）之间的通信。
- **作用**：同一节点内的 Pod 通过网桥实现二层通信（无需路由），减少跨节点转发的开销。
- **常见名称**：
  - Flannel、Weave Net 等插件默认创建 `cni0` 网桥。
  - Docker 原生网络会创建 `docker0` 网桥（K8s 中通常被 CNI 网桥替代）。
- **工作原理**：
  - 节点内所有 Pod 的 veth 对节点端都连接到网桥。
  - 当 Pod A 访问同一节点的 Pod B 时，数据包通过 veth 对到达网桥，网桥根据 MAC 地址表直接转发到 Pod B 的 veth 设备。


### 3. 隧道设备（Tunnel，如 flannel.1、vxlan.calico）
- **本质**：用于在物理网络之上构建虚拟网络的设备，通过封装/解封装技术（如 VXLAN、GRE）实现跨节点 Pod 通信。
- **作用**：解决跨节点 Pod 通信的“IP 网段隔离”问题（不同节点的 Pod 可能属于不同子网），使跨节点 Pod 感觉处于同一二层网络。
- **常见类型**：
  - **VXLAN 隧道**：Flannel（`flannel.1`）、Calico（`vxlan.calico`）等插件默认使用，通过 UDP 封装数据包（端口 4789）。
  - **Geneve 隧道**：较新的隧道协议，支持更灵活的网络策略，Cilium 等插件常用。
- **工作原理**：
  - 节点 A 的 Pod 发送数据到节点 B 的 Pod 时，数据包先到达节点 A 的隧道设备。
  - 隧道设备将 Pod 数据包（源/目标为 Pod IP）封装在物理网络数据包中（源/目标为节点物理 IP），通过物理网络发送到节点 B。
  - 节点 B 的隧道设备解封装，得到原始 Pod 数据包，再转发到目标 Pod。


### 4. 路由设备（Route，如 Calico 的 BGP 路由）
- **本质**：通过 Linux 内核路由表实现跨节点 Pod 通信的逻辑设备（无实体网卡，依赖路由规则）。
- **作用**：在 Underlay 网络模式中，直接通过路由表将跨节点 Pod 数据包转发到目标节点，无需隧道封装。
- **典型场景**：Calico 插件的“BGP 路由模式”，通过 BGP 协议在节点间同步 Pod 子网与节点的映射关系。
- **工作原理**：
  - 每个节点通过 BGP 协议向集群内其他节点宣告：“我负责 10.244.1.0/24 网段的 Pod”。
  - 当节点 A 需要访问节点 B 的 Pod（IP：10.244.2.5）时，节点 A 的路由表会匹配到“10.244.2.0/24 网段走节点 B 的物理 IP”，直接将数据包通过物理网络发送到节点 B。


### 5. 网络接口对（如 lo 回环接口）
- **本质**：每个网络命名空间内的回环接口（`lo`），用于本地进程间通信。
- **作用**：Pod 内的容器通过 `lo` 接口（`localhost`）通信（如容器 A 访问 `localhost:8080` 访问同一 Pod 内的容器 B）。
- **特点**：`lo` 接口的 IP 固定为 `127.0.0.1`，仅在 Pod 内部可见。


### 6. 虚拟网卡（如 macvlan、ipvlan）
- **本质**：直接为 Pod 分配虚拟 MAC 地址或 IP 地址，模拟物理网卡的设备，属于 Underlay 网络技术。
- **作用**：让 Pod 直接接入物理网络（与节点共享物理网卡），Pod IP 与物理网络在同一网段，实现低延迟通信。
- **常见类型**：
  - **macvlan**：为每个 Pod 分配独立 MAC 地址，物理交换机需支持“多 MAC 地址接入”。
  - **ipvlan**：共享物理网卡的 MAC 地址，仅分配独立 IP，兼容性更好。
- **适用场景**：对网络延迟敏感的场景（如 AI 训练、高频交易），需物理网络配合。


### 总结：虚拟网络设备的协同关系
K8s 网络通过多种虚拟设备的协同，实现了 Pod 从“本地通信”到“跨节点通信”的全链路：
1. **Pod 内部**：通过 `lo` 回环接口实现容器间通信。
2. **同一节点**：Pod 的 `eth0` 经 veth 对连接到节点网桥（如 `cni0`），通过网桥转发实现 Pod 间通信。
3. **跨节点（Overlay）**：通过隧道设备（如 `flannel.1`）封装数据包，经物理网络传输到目标节点后解封装。
4. **跨节点（Underlay）**：通过路由设备（BGP 路由）或虚拟网卡（macvlan），直接在物理网络中转发数据包。

不同 CNI 插件会组合使用上述设备（如 Flannel 用 veth + 网桥 + VXLAN 隧道，Calico 用 veth + BGP 路由），最终实现 K8s 网络模型的核心目标：“每个 Pod 一个 IP，直接通信”。